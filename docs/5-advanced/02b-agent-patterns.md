---
title: 5.2b Agent è®¾è®¡æ¨¡å¼
subtitle: ä¸šç•Œæœ€ä½³å®è·µä¸å®æˆ˜æ¡ˆä¾‹
course: OpenCode ä¸­æ–‡å®æˆ˜è¯¾
stage: ç¬¬äº”é˜¶æ®µ
lesson: "5.2b"
duration: 25 åˆ†é’Ÿ
practice: 30 åˆ†é’Ÿ
level: è¿›é˜¶
description: å­¦ä¹ ä¸šç•Œ Agent è®¾è®¡æ¨¡å¼ï¼ŒæŒæ¡åˆ›å»ºé«˜æ•ˆ Agent çš„æœ€ä½³å®è·µï¼Œå‚è€ƒ Anthropic å’Œ Lilian Weng çš„ç»éªŒã€‚
tags:
  - Agent
  - è®¾è®¡æ¨¡å¼
  - æœ€ä½³å®è·µ
prerequisite:
  - 5.2a Agent å¿«é€Ÿå…¥é—¨
---

# 5.2b Agent è®¾è®¡æ¨¡å¼

> æ¥æºï¼šAnthropicã€ŠBuilding Effective Agentsã€‹ã€Lilian Wengã€ŠLLM Powered Autonomous Agentsã€‹

## ğŸ“ è¯¾ç¨‹ç¬”è®°

æœ¬è¯¾æ ¸å¿ƒçŸ¥è¯†ç‚¹æ•´ç†ï¼š

<img src="/images/5-advanced/02b-agent-patterns-notes.mini.jpeg" alt="Agentè®¾è®¡æ¨¡å¼å­¦éœ¸ç¬”è®°" data-zoom-src="/images/5-advanced/02b-agent-patterns-notes.jpeg" />

---

## å­¦å®Œä½ èƒ½åšä»€ä¹ˆ

- é€‰æ‹©åˆé€‚çš„ Agent æ¶æ„
- å®ç°äº”ç§ Workflow æ¨¡å¼
- è®¾è®¡å¤æ‚çš„å¤š Agent åä½œç³»ç»Ÿ
- é¿å…å¸¸è§çš„è®¾è®¡é™·é˜±

---

## æ ¸å¿ƒåŸåˆ™

Anthropic åœ¨ä¸æ•°åä¸ªå›¢é˜Ÿåˆä½œæ„å»º Agent åæ€»ç»“å‡ºä¸‰æ¡æ ¸å¿ƒåŸåˆ™ï¼š

### 1. ä¿æŒç®€å•

> "æœ€æˆåŠŸçš„å®ç°ä½¿ç”¨ç®€å•ã€å¯ç»„åˆçš„æ¨¡å¼ï¼Œè€Œéå¤æ‚æ¡†æ¶ã€‚"

**å®è·µ**ï¼š
- èƒ½ç”¨å•ä¸ª Agent è§£å†³çš„ï¼Œä¸è¦ç”¨å¤šä¸ª
- èƒ½ç”¨å›ºå®šæµç¨‹çš„ï¼Œä¸è¦ç”¨åŠ¨æ€å†³ç­–
- èƒ½ç”¨ prompt è§£å†³çš„ï¼Œä¸è¦åŠ å·¥å…·

### 2. é€æ˜åº¦ä¼˜å…ˆ

> "æ˜¾å¼å±•ç¤º Agent çš„è§„åˆ’æ­¥éª¤ã€‚"

**å®è·µ**ï¼š
- Agent çš„æ€è€ƒè¿‡ç¨‹åº”è¯¥å¯è§
- æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ˜ç¡®çš„è¾“å…¥è¾“å‡º
- ç”¨æˆ·èƒ½ç†è§£ Agent åœ¨åšä»€ä¹ˆ

### 3. ç²¾å¿ƒè®¾è®¡å·¥å…·æ¥å£ï¼ˆACIï¼‰

<AdInArticle />

> "åƒè®¾è®¡äººæœºç•Œé¢ï¼ˆHCIï¼‰ä¸€æ ·æŠ•å…¥ç²¾åŠ›è®¾è®¡ Agent-è®¡ç®—æœºç•Œé¢ï¼ˆACIï¼‰ã€‚"

**å®è·µ**ï¼š
- å·¥å…·æè¿°è¦åƒç»™åˆçº§å¼€å‘è€…å†™çš„ä¼˜ç§€ docstring
- åŒ…å«ä½¿ç”¨ç¤ºä¾‹å’Œè¾¹ç•Œæƒ…å†µ
- é¿å…éœ€è¦ç²¾ç¡®è®¡æ•°æˆ–å¤æ‚è½¬ä¹‰çš„æ ¼å¼

---

## Workflow vs Agentï¼šå¦‚ä½•é€‰æ‹©

| ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | OpenCode å®ç° |
|------|------|---------|--------------|
| **Workflow** | é¢„å®šä¹‰ä»£ç è·¯å¾„ï¼Œæ­¥éª¤å›ºå®š | ä»»åŠ¡å¯é¢„æµ‹ã€ç»“æ„æ¸…æ™° | Skillã€Command |
| **Agent** | LLM åŠ¨æ€å†³ç­–ï¼Œè‡ªä¸»æ¢ç´¢ | å¼€æ”¾æ€§é—®é¢˜ã€æ— æ³•é¢„æµ‹æ­¥éª¤ | Agent + Task tool |

### é€‰æ‹©æµç¨‹å›¾

```
ä»»åŠ¡æ¥äº†
    â†“
æ­¥éª¤æ˜¯å¦å›ºå®šï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ç”¨ Workflowï¼ˆSkill/Commandï¼‰
    â””â”€ å¦ â†’ éœ€è¦å¤šå°‘è‡ªä¸»æ€§ï¼Ÿ
              â”œâ”€ ä½ â†’ å—é™ Agentï¼ˆsteps + æƒé™æ§åˆ¶ï¼‰
              â””â”€ é«˜ â†’ å®Œå…¨è‡ªä¸» Agent
```

---

## äº”ç§ Workflow æ¨¡å¼

### æ¨¡å¼ 1ï¼šPrompt Chainingï¼ˆæç¤ºé“¾ï¼‰

**åŸç†**ï¼šå°†ä»»åŠ¡åˆ†è§£ä¸ºé¡ºåºæ‰§è¡Œçš„æ­¥éª¤ï¼Œæ¯ä¸€æ­¥çš„è¾“å‡ºæ˜¯ä¸‹ä¸€æ­¥çš„è¾“å…¥ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- ä»»åŠ¡å¯ä»¥æ¸…æ™°åˆ†è§£ä¸ºå›ºå®šå­ä»»åŠ¡
- éœ€è¦ç”¨å»¶è¿Ÿæ¢å–å‡†ç¡®æ€§

**ç¤ºä¾‹**ï¼šç¿»è¯‘ + æ¶¦è‰² + æ ¼å¼åŒ–

```markdown
---
description: å¤šæ­¥éª¤ç¿»è¯‘å¤„ç†
mode: subagent
steps: 10
---

# ä»»åŠ¡æµç¨‹

æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼Œæ¯æ­¥å®Œæˆåå†è¿›è¡Œä¸‹ä¸€æ­¥ï¼š

## æ­¥éª¤ 1ï¼šç›´è¯‘
å°†åŸæ–‡é€å¥ç¿»è¯‘æˆä¸­æ–‡ï¼Œä¿æŒåŸæ„ã€‚

## æ­¥éª¤ 2ï¼šæ„è¯‘æ¶¦è‰²
åœ¨ç›´è¯‘åŸºç¡€ä¸Šï¼Œè°ƒæ•´ä¸ºé€šé¡ºçš„ä¸­æ–‡è¡¨è¾¾ã€‚

## æ­¥éª¤ 3ï¼šä¸“ä¸šæœ¯è¯­æ£€æŸ¥
æ£€æŸ¥ä¸“ä¸šæœ¯è¯­æ˜¯å¦å‡†ç¡®ï¼Œå¿…è¦æ—¶ä¿ç•™è‹±æ–‡ã€‚

## æ­¥éª¤ 4ï¼šæ ¼å¼åŒ–
æŒ‰ç…§ç›®æ ‡æ ¼å¼ï¼ˆMarkdownï¼‰æ•´ç†è¾“å‡ºã€‚

# è¾“å‡ºè¦æ±‚
æ¯ä¸ªæ­¥éª¤éƒ½è¾“å‡ºä¸­é—´ç»“æœï¼Œæœ€åç»™å‡ºæœ€ç»ˆç‰ˆæœ¬ã€‚
```

---

### æ¨¡å¼ 2ï¼šRoutingï¼ˆè·¯ç”±ï¼‰

**åŸç†**ï¼šæ ¹æ®è¾“å…¥ç‰¹å¾ï¼Œå°†ä»»åŠ¡å¯¼å‘ä¸åŒçš„ä¸“é—¨å¤„ç†æµç¨‹ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¸åŒç±»åˆ«éœ€è¦ä¸åŒå¤„ç†æ–¹å¼
- åˆ†ç±»å¯ä»¥å‡†ç¡®å®Œæˆ

**ç¤ºä¾‹**ï¼šä»£ç é—®é¢˜åˆ†ç±»å™¨

```markdown
---
description: ä»£ç é—®é¢˜åˆ†ç±»è·¯ç”±å™¨
mode: subagent
---

# è§’è‰²
ä½ æ˜¯ä»£ç é—®é¢˜åˆ†ç±»ä¸“å®¶ï¼Œè´Ÿè´£å°†é—®é¢˜è·¯ç”±åˆ°æ­£ç¡®çš„å¤„ç†æµç¨‹ã€‚

# åˆ†ç±»è§„åˆ™

åˆ†æç”¨æˆ·çš„ä»£ç é—®é¢˜ï¼Œåˆ¤æ–­å±äºä»¥ä¸‹å“ªä¸€ç±»ï¼š

1. **Bug ä¿®å¤** â†’ è°ƒç”¨ @bug-fixer
   - ç‰¹å¾ï¼šä»£ç æŠ¥é”™ã€è¡Œä¸ºä¸ç¬¦åˆé¢„æœŸ

2. **æ€§èƒ½ä¼˜åŒ–** â†’ è°ƒç”¨ @performance-optimizer
   - ç‰¹å¾ï¼šè¿è¡Œæ…¢ã€å†…å­˜å ç”¨é«˜

3. **å®‰å…¨å®¡è®¡** â†’ è°ƒç”¨ @security-auditor
   - ç‰¹å¾ï¼šæ¶‰åŠè®¤è¯ã€æ•°æ®å¤„ç†ã€å¤–éƒ¨è¾“å…¥

4. **ä»£ç é‡æ„** â†’ è°ƒç”¨ @refactor-expert
   - ç‰¹å¾ï¼šä»£ç å¯ä»¥å·¥ä½œä½†éœ€è¦æ”¹è¿›ç»“æ„

5. **æ–°åŠŸèƒ½å¼€å‘** â†’ ä¸è·¯ç”±ï¼Œç›´æ¥å¤„ç†
   - ç‰¹å¾ï¼šå®ç°æ–°éœ€æ±‚

# è¾“å‡ºæ ¼å¼
å…ˆè¯´æ˜åˆ†ç±»ç†ç”±ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„ subagentã€‚
```

**é…åˆ Task æƒé™æ§åˆ¶**ï¼š

```jsonc
{
  "agent": {
    "router": {
      "description": "ä»£ç é—®é¢˜åˆ†ç±»è·¯ç”±å™¨",
      "mode": "primary",
      "permission": {
        "task": {
          "*": "deny",
          "bug-fixer": "allow",
          "performance-optimizer": "allow",
          "security-auditor": "allow",
          "refactor-expert": "allow"
        }
      }
    }
  }
}
```

---

### æ¨¡å¼ 3ï¼šParallelizationï¼ˆå¹¶è¡ŒåŒ–ï¼‰

**åŸç†**ï¼šå¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œæœ€åæ±‡æ€»ç»“æœã€‚

**ä¸¤ç§å˜ä½“**ï¼š
- **Sectioningï¼ˆåˆ†ç‰‡ï¼‰**ï¼šç‹¬ç«‹å­ä»»åŠ¡å¹¶è¡Œ
- **Votingï¼ˆæŠ•ç¥¨ï¼‰**ï¼šåŒä¸€ä»»åŠ¡å¤šè§†è§’éªŒè¯

**é€‚ç”¨åœºæ™¯**ï¼š
- å­ä»»åŠ¡ç›¸äº’ç‹¬ç«‹
- éœ€è¦å¤šè§†è§’æé«˜å‡†ç¡®æ€§
- æ—¶é—´æ•æ„Ÿï¼Œéœ€è¦åŠ é€Ÿ

**ç¤ºä¾‹ï¼šä»£ç è´¨é‡å¹¶è¡Œæ£€æŸ¥**

```markdown
---
description: ä»£ç è´¨é‡å¹¶è¡Œæ£€æŸ¥å™¨
mode: subagent
---

# ä»»åŠ¡
å¯¹ç»™å®šä»£ç åŒæ—¶è¿›è¡Œå¤šç»´åº¦æ£€æŸ¥ã€‚

# å¹¶è¡Œä»»åŠ¡

**åŒæ—¶**è°ƒç”¨ä»¥ä¸‹ subagentï¼ˆä½¿ç”¨å¤šä¸ª Task tool è°ƒç”¨ï¼‰ï¼š

1. @security-auditor - å®‰å…¨æ¼æ´æ£€æŸ¥
2. @performance-reviewer - æ€§èƒ½åˆ†æ
3. @style-checker - ä»£ç é£æ ¼æ£€æŸ¥
4. @test-coverage-analyzer - æµ‹è¯•è¦†ç›–åˆ†æ

# æ±‡æ€»è§„åˆ™

æ”¶é›†æ‰€æœ‰ç»“æœåï¼Œç”Ÿæˆç»¼åˆæŠ¥å‘Šï¼š

## ç»¼åˆè¯„åˆ†
- å®‰å…¨æ€§ï¼šX/10
- æ€§èƒ½ï¼šX/10
- ä»£ç é£æ ¼ï¼šX/10
- æµ‹è¯•è¦†ç›–ï¼šX/10
- **æ€»åˆ†**ï¼šX/40

## é—®é¢˜æ±‡æ€»
æŒ‰ä¸¥é‡ç¨‹åº¦æ’åºæ‰€æœ‰å‘ç°çš„é—®é¢˜ã€‚

## ä¼˜å…ˆä¿®å¤å»ºè®®
ç»™å‡ºæœ€åº”è¯¥ä¼˜å…ˆå¤„ç†çš„ 3 ä¸ªé—®é¢˜ã€‚
```

---

### æ¨¡å¼ 4ï¼šOrchestrator-Workersï¼ˆç¼–æ’-å·¥äººï¼‰

**åŸç†**ï¼šä¸­å¤® LLMï¼ˆç¼–æ’å™¨ï¼‰åŠ¨æ€åˆ†æä»»åŠ¡ï¼Œå°†å…¶åˆ†è§£å¹¶åˆ†é…ç»™ä¸“é—¨çš„ Worker Agentã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- æ— æ³•é¢„æµ‹éœ€è¦å“ªäº›å­ä»»åŠ¡
- ä»»åŠ¡å¤æ‚åº¦ä¸ç¡®å®š
- éœ€è¦çµæ´»åº”å¯¹

**ç¤ºä¾‹ï¼šé¡¹ç›®åˆ†æç¼–æ’å™¨**

```markdown
---
description: é¡¹ç›®åˆ†æç¼–æ’å™¨ï¼ŒåŠ¨æ€åˆ†é…åˆ†æä»»åŠ¡
mode: primary
---

# è§’è‰²
ä½ æ˜¯é¡¹ç›®åˆ†æç¼–æ’å™¨ï¼Œè´Ÿè´£ç†è§£ç”¨æˆ·éœ€æ±‚å¹¶åè°ƒä¸“å®¶å›¢é˜Ÿã€‚

# å¯ç”¨ä¸“å®¶

ä½ å¯ä»¥è°ƒç”¨ä»¥ä¸‹ä¸“å®¶ï¼ˆæ ¹æ®éœ€è¦é€‰æ‹©ï¼‰ï¼š

- @architecture-analyst - æ¶æ„åˆ†æï¼Œé€‚åˆ"è¿™ä¸ªé¡¹ç›®ç»“æ„æ€ä¹ˆæ ·"
- @dependency-auditor - ä¾èµ–å®¡è®¡ï¼Œé€‚åˆ"æœ‰æ²¡æœ‰è¿‡æ—¶/å±é™©çš„ä¾èµ–"
- @security-auditor - å®‰å…¨å®¡è®¡ï¼Œé€‚åˆ"æœ‰æ²¡æœ‰å®‰å…¨éšæ‚£"
- @performance-profiler - æ€§èƒ½åˆ†æï¼Œé€‚åˆ"å“ªé‡Œå¯èƒ½æ˜¯ç“¶é¢ˆ"
- @docs-reviewer - æ–‡æ¡£è¯„å®¡ï¼Œé€‚åˆ"æ–‡æ¡£æ˜¯å¦å®Œæ•´"
- @test-analyzer - æµ‹è¯•åˆ†æï¼Œé€‚åˆ"æµ‹è¯•è¦†ç›–æ˜¯å¦è¶³å¤Ÿ"

# å·¥ä½œæµç¨‹

1. **ç†è§£éœ€æ±‚**ï¼šåˆ†æç”¨æˆ·æƒ³çŸ¥é“ä»€ä¹ˆ
2. **åˆ¶å®šè®¡åˆ’**ï¼šå†³å®šéœ€è¦è°ƒç”¨å“ªäº›ä¸“å®¶ï¼Œä»¥ä»€ä¹ˆé¡ºåº
3. **æ‰§è¡Œåˆ†æ**ï¼šè°ƒç”¨é€‰å®šçš„ä¸“å®¶
4. **æ•´åˆç»“æœ**ï¼šæ±‡æ€»æ‰€æœ‰ä¸“å®¶çš„å‘ç°
5. **ç»™å‡ºå»ºè®®**ï¼šåŸºäºæ•´ä½“åˆ†æç»™å‡ºè¡ŒåŠ¨å»ºè®®

# åŸåˆ™
- ä¸è¦è¿‡åº¦åˆ†æï¼Œæ ¹æ®ç”¨æˆ·éœ€æ±‚é€‰æ‹©å¿…è¦çš„ä¸“å®¶
- å¦‚æœç”¨æˆ·é—®é¢˜ç®€å•ï¼Œå¯èƒ½ä¸éœ€è¦ä»»ä½•ä¸“å®¶
- ä¸“å®¶çš„åˆ†æç»“æœå¯èƒ½ä¼šè§¦å‘æ›´å¤šåˆ†æéœ€æ±‚
```

---

### æ¨¡å¼ 5ï¼šEvaluator-Optimizerï¼ˆè¯„ä¼°-ä¼˜åŒ–ï¼‰

**åŸç†**ï¼šä¸€ä¸ª Agent ç”Ÿæˆå†…å®¹ï¼Œå¦ä¸€ä¸ª Agent è¯„ä¼°ï¼Œå¾ªç¯ç›´åˆ°æ»¡è¶³æ ‡å‡†ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- æœ‰æ˜ç¡®çš„è¯„ä¼°æ ‡å‡†
- è¿­ä»£æ”¹è¿›æœ‰ä»·å€¼
- ç±»ä¼¼äººç±»çš„"å†™ä½œ-ä¿®æ”¹"è¿‡ç¨‹

**ç¤ºä¾‹ï¼šä»£ç ä¼˜åŒ–å¾ªç¯**

```markdown
---
description: è¿­ä»£ä»£ç ä¼˜åŒ–å™¨
mode: subagent
steps: 15
---

# è§’è‰²
ä½ æ˜¯ä»£ç ä¼˜åŒ–ä¸“å®¶ï¼Œé€šè¿‡è¿­ä»£æ”¹è¿›ä»£ç è´¨é‡ã€‚

# ä¼˜åŒ–å¾ªç¯

æ‰§è¡Œä»¥ä¸‹å¾ªç¯ï¼Œç›´åˆ°æ»¡è¶³ç›®æ ‡æˆ–è¾¾åˆ°æ­¥æ•°é™åˆ¶ï¼š

## 1. åˆ†æé˜¶æ®µ
- é˜…è¯»å½“å‰ä»£ç 
- è¯†åˆ«å¯ä¼˜åŒ–ç‚¹
- è¯„ä¼°å½“å‰è´¨é‡åˆ†æ•°ï¼ˆè§è¯„åˆ†æ ‡å‡†ï¼‰

## 2. ä¼˜åŒ–é˜¶æ®µ
- é€‰æ‹©å½±å“æœ€å¤§çš„ä¼˜åŒ–ç‚¹
- å®æ–½ä¼˜åŒ–
- ç¡®ä¿ä¸ç ´ååŠŸèƒ½

## 3. éªŒè¯é˜¶æ®µ
- è¿è¡Œæµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
- é‡æ–°è¯„ä¼°è´¨é‡åˆ†æ•°

## 4. å†³ç­–é˜¶æ®µ
- å¦‚æœè´¨é‡åˆ†æ•° >= 8ï¼Œåœæ­¢ä¼˜åŒ–
- å¦‚æœè´¨é‡åˆ†æ•°æå‡ < 0.5ï¼Œåœæ­¢ï¼ˆè¾¹é™…æ•ˆç›Šä¸è¶³ï¼‰
- å¦åˆ™ï¼Œç»§ç»­ä¸‹ä¸€è½®

# è´¨é‡è¯„åˆ†æ ‡å‡†

| åˆ†æ•° | å¯è¯»æ€§ | æ€§èƒ½ | å®‰å…¨æ€§ | æµ‹è¯•è¦†ç›– |
|------|--------|------|--------|---------|
| 9-10 | å‘½åæ¸…æ™°ã€æ³¨é‡Šå®Œæ•´ | O(n)æˆ–æ›´ä¼˜ | æ— æ¼æ´ | >90% |
| 7-8 | å‘½ååˆç†ã€å…³é”®æ³¨é‡Š | O(n log n) | ä½é£é™© | 70-90% |
| 5-6 | åŸºæœ¬å¯è¯» | O(nÂ²) | ä¸­é£é™© | 50-70% |
| <5 | éš¾ä»¥ç†è§£ | O(nÂ³)+ | é«˜é£é™© | <50% |

ç»¼åˆå¾—åˆ† = å¯è¯»æ€§Ã—0.3 + æ€§èƒ½Ã—0.3 + å®‰å…¨æ€§Ã—0.25 + æµ‹è¯•è¦†ç›–Ã—0.15

# è¾“å‡º
æ¯è½®è¾“å‡ºï¼š
- æœ¬è½®ä¼˜åŒ–å†…å®¹
- å„ç»´åº¦å¾—åˆ†æ˜ç»†
- è´¨é‡åˆ†æ•°å˜åŒ–
- æ˜¯å¦ç»§ç»­çš„å†³ç­–ç†ç”±

æœ€ç»ˆè¾“å‡ºï¼š
- ä¼˜åŒ–æ€»ç»“
- å‰åå¯¹æ¯”
- è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®ï¼ˆå¦‚æœ‰ï¼‰

# å¤±è´¥å¤„ç†
- æµ‹è¯•å¤±è´¥ï¼šç«‹å³å›æ»šæœ¬è½®ä¿®æ”¹ï¼Œè®°å½•å¤±è´¥åŸå› ï¼Œå°è¯•å…¶ä»–ä¼˜åŒ–æ–¹å‘
- æ­¥æ•°è€—å°½ï¼šè¾“å‡ºå½“å‰æœ€ä½³ç‰ˆæœ¬å’Œå‰©ä½™ä¼˜åŒ–å»ºè®®
- æ— æ³•ç»§ç»­ä¼˜åŒ–ï¼šè¯´æ˜åŸå› ï¼Œç»™å‡ºå·²è¾¾åˆ°çš„è´¨é‡æ°´å¹³
```

---

## Agent ä¸‰å¤§ç»„ä»¶è®¾è®¡

æ ¹æ® Lilian Weng çš„ç ”ç©¶ï¼Œä¸€ä¸ªå®Œæ•´çš„ Agent ç³»ç»ŸåŒ…å«ä¸‰å¤§ç»„ä»¶ï¼š

### 1. Planningï¼ˆè§„åˆ’ï¼‰

**ä»»åŠ¡åˆ†è§£æŠ€æœ¯**ï¼š

| æŠ€æœ¯ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **Chain of Thought** | "ä¸€æ­¥æ­¥æ€è€ƒ" | é€šç”¨æ¨ç† |
| **Tree of Thoughts** | æ¢ç´¢å¤šä¸ªæ¨ç†è·¯å¾„ | å¤æ‚å†³ç­– |
| **ReAct** | æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯ | éœ€è¦ä¸ç¯å¢ƒäº¤äº’ |

**åœ¨ Agent prompt ä¸­åº”ç”¨**ï¼š

```markdown
# å·¥ä½œæ–¹å¼

é‡‡ç”¨ ReAct æ¨¡å¼ï¼š

1. **æ€è€ƒ**ï¼šåˆ†æå½“å‰çŠ¶æ€ï¼Œå†³å®šä¸‹ä¸€æ­¥
2. **è¡ŒåŠ¨**ï¼šæ‰§è¡Œå…·ä½“æ“ä½œï¼ˆè°ƒç”¨å·¥å…·ï¼‰
3. **è§‚å¯Ÿ**ï¼šåˆ†ææ“ä½œç»“æœ
4. **é‡å¤**ï¼šç›´åˆ°ä»»åŠ¡å®Œæˆ
```

### 2. Memoryï¼ˆè®°å¿†ï¼‰

| ç±»å‹ | å¯¹åº” | ç‰¹ç‚¹ |
|------|------|------|
| **çŸ­æœŸè®°å¿†** | ä¸Šä¸‹æ–‡çª—å£ | æœ‰é™ï¼Œçº¦å‡ ä¸‡ token |
| **é•¿æœŸè®°å¿†** | å¤–éƒ¨å‘é‡åº“ | æ— é™ï¼Œéœ€è¦æ£€ç´¢ |

**OpenCode ä¸­çš„å®ç°**ï¼š
- çŸ­æœŸï¼šä¼šè¯ä¸Šä¸‹æ–‡
- é•¿æœŸï¼šMCP é›†æˆå‘é‡æ•°æ®åº“

### 3. Tool Useï¼ˆå·¥å…·ä½¿ç”¨ï¼‰

**å·¥å…·è®¾è®¡åŸåˆ™**ï¼š

1. **æè¿°æ¸…æ™°**ï¼šåƒç»™åˆçº§å¼€å‘è€…çš„ docstring
2. **è¾“å…¥ç®€å•**ï¼šé¿å…å¤æ‚çš„æ ¼å¼è¦æ±‚
3. **è¾“å‡ºå¯è§£æ**ï¼šç»“æ„åŒ–ï¼Œä¾¿äºåç»­å¤„ç†
4. **é”™è¯¯å‹å¥½**ï¼šæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

---

## å®æˆ˜æ¡ˆä¾‹ 1ï¼šå¤šè¯­è¨€æ–‡æ¡£ç”Ÿæˆç³»ç»Ÿ

**éœ€æ±‚**ï¼šè‡ªåŠ¨å°† API æ–‡æ¡£ç¿»è¯‘æˆå¤šè¯­è¨€ç‰ˆæœ¬ã€‚

### ç³»ç»Ÿè®¾è®¡

```
ç”¨æˆ·è¾“å…¥ API æ–‡æ¡£
       â†“
   @doc-parserï¼ˆè§£ææ–‡æ¡£ç»“æ„ï¼‰
       â†“
   @translator-zhï¼ˆç¿»è¯‘æˆä¸­æ–‡ï¼‰
   @translator-jaï¼ˆç¿»è¯‘æˆæ—¥æ–‡ï¼‰  â† å¹¶è¡Œ
   @translator-koï¼ˆç¿»è¯‘æˆéŸ©æ–‡ï¼‰
       â†“
   @doc-formatterï¼ˆæ ¼å¼åŒ–è¾“å‡ºï¼‰
       â†“
   å¤šè¯­è¨€æ–‡æ¡£
```

### é…ç½®æ–‡ä»¶

```jsonc
// opencode.json
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "doc-generator": {
      "description": "å¤šè¯­è¨€æ–‡æ¡£ç”Ÿæˆç¼–æ’å™¨",
      "mode": "primary",
      "prompt": "{file:./prompts/doc-generator.md}",
      "permission": {
        "task": {
          "*": "deny",
          "doc-parser": "allow",
          "translator-*": "allow",
          "doc-formatter": "allow"
        }
      }
    },
    "doc-parser": {
      "description": "è§£æ API æ–‡æ¡£ç»“æ„ï¼Œæå–å¯ç¿»è¯‘å†…å®¹",
      "mode": "subagent",
      "temperature": 0.1
    },
    "translator-zh": {
      "description": "è‹±è¯‘ä¸­ä¸“å®¶ï¼Œä¿æŒæŠ€æœ¯æœ¯è¯­å‡†ç¡®",
      "mode": "subagent",
      "temperature": 0.3
    },
    "translator-ja": {
      "description": "è‹±è¯‘æ—¥ä¸“å®¶",
      "mode": "subagent",
      "temperature": 0.3
    },
    "translator-ko": {
      "description": "è‹±è¯‘éŸ©ä¸“å®¶",
      "mode": "subagent",
      "temperature": 0.3
    },
    "doc-formatter": {
      "description": "æ–‡æ¡£æ ¼å¼åŒ–ï¼Œç¡®ä¿å¤šè¯­è¨€ç‰ˆæœ¬æ ¼å¼ä¸€è‡´",
      "mode": "subagent",
      "temperature": 0.1
    }
  }
}
```

### ç¼–æ’å™¨ Prompt

```markdown
<!-- prompts/doc-generator.md -->
---
description: å¤šè¯­è¨€æ–‡æ¡£ç”Ÿæˆç¼–æ’å™¨
mode: primary
---

# è§’è‰²
ä½ æ˜¯å¤šè¯­è¨€æ–‡æ¡£ç”Ÿæˆç³»ç»Ÿçš„ç¼–æ’å™¨ã€‚

# å·¥ä½œæµç¨‹

## 1. è§£æé˜¶æ®µ
è°ƒç”¨ @doc-parser åˆ†æè¾“å…¥æ–‡æ¡£ï¼š
- æå–æ ‡é¢˜ã€æè¿°ã€å‚æ•°ã€è¿”å›å€¼ç­‰ç»“æ„
- æ ‡è®°å“ªäº›å†…å®¹éœ€è¦ç¿»è¯‘
- å“ªäº›å†…å®¹ä¿æŒåŸæ ·ï¼ˆå¦‚ä»£ç ç¤ºä¾‹ï¼‰

## 2. ç¿»è¯‘é˜¶æ®µ
**å¹¶è¡Œ**è°ƒç”¨ç¿»è¯‘ä¸“å®¶ï¼š
- @translator-zhï¼šç¿»è¯‘æˆä¸­æ–‡
- @translator-jaï¼šç¿»è¯‘æˆæ—¥æ–‡
- @translator-koï¼šç¿»è¯‘æˆéŸ©æ–‡

å‘Šè¯‰æ¯ä¸ªç¿»è¯‘ä¸“å®¶ï¼š
- æ–‡æ¡£ç»“æ„
- éœ€è¦ç¿»è¯‘çš„å†…å®¹
- æœ¯è¯­è¡¨ï¼ˆå¦‚æœ‰ï¼‰

## 3. æ ¼å¼åŒ–é˜¶æ®µ
è°ƒç”¨ @doc-formatterï¼š
- å°†å„è¯­è¨€ç‰ˆæœ¬æ•´åˆ
- ç¡®ä¿æ ¼å¼ä¸€è‡´
- ç”Ÿæˆæœ€ç»ˆè¾“å‡º

# è¾“å‡ºæ ¼å¼
ç”ŸæˆåŒ…å«æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬çš„ç›®å½•ç»“æ„å»ºè®®ã€‚
```

---

## å®æˆ˜æ¡ˆä¾‹ 2ï¼šä»£ç å®¡è®¡æµæ°´çº¿

**éœ€æ±‚**ï¼šå¯¹ PR è¿›è¡Œå…¨æ–¹ä½ä»£ç å®¡è®¡ã€‚

### ç³»ç»Ÿè®¾è®¡

é‡‡ç”¨ **Parallelization + Orchestrator-Workers** æ··åˆæ¨¡å¼ã€‚

```
PR ä»£ç å˜æ›´
       â†“
   @audit-coordinatorï¼ˆåè°ƒå™¨ï¼‰
       â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  å¹¶è¡Œæ‰§è¡Œï¼ˆSectioningï¼‰          â”‚
   â”‚  @security-auditor              â”‚
   â”‚  @performance-auditor           â”‚
   â”‚  @quality-auditor               â”‚
   â”‚  @test-auditor                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
   æ±‡æ€»æ‰€æœ‰å‘ç°
       â†“
   @report-generatorï¼ˆç”ŸæˆæŠ¥å‘Šï¼‰
       â†“
   å®¡è®¡æŠ¥å‘Š
```

### é…ç½®æ–‡ä»¶

```jsonc
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "audit-coordinator": {
      "description": "ä»£ç å®¡è®¡åè°ƒå™¨ï¼Œç¼–æ’å¤šç»´åº¦å®¡è®¡",
      "mode": "subagent",
      "model": "anthropic/claude-opus-4-5-thinking",
      "prompt": "{file:./prompts/audit-coordinator.md}",
      "steps": 50
    },
    "security-auditor": {
      "description": "å®‰å…¨æ¼æ´å®¡è®¡ï¼šæ³¨å…¥ã€è®¤è¯ã€æ•°æ®æ³„éœ²",
      "mode": "subagent",
      "temperature": 0.1,
      "prompt": "{file:./prompts/security-auditor.md}",
      "permission": {
        "edit": "deny"
      }
    },
    "performance-auditor": {
      "description": "æ€§èƒ½å®¡è®¡ï¼šå¤æ‚åº¦ã€å†…å­˜ã€å¹¶å‘",
      "mode": "subagent",
      "temperature": 0.1,
      "permission": {
        "edit": "deny"
      }
    },
    "quality-auditor": {
      "description": "ä»£ç è´¨é‡å®¡è®¡ï¼šå¯è¯»æ€§ã€SOLIDã€é‡å¤ä»£ç ",
      "mode": "subagent",
      "temperature": 0.2,
      "permission": {
        "edit": "deny"
      }
    },
    "test-auditor": {
      "description": "æµ‹è¯•å®¡è®¡ï¼šè¦†ç›–ç‡ã€è¾¹ç•Œæƒ…å†µã€Mock è´¨é‡",
      "mode": "subagent",
      "temperature": 0.1,
      "permission": {
        "edit": "deny",
        "bash": {
          "*": "deny",
          "npm test*": "allow",
          "npm run test*": "allow"
        }
      }
    },
    "report-generator": {
      "description": "ç”Ÿæˆç»“æ„åŒ–å®¡è®¡æŠ¥å‘Š",
      "mode": "subagent",
      "temperature": 0.2
    }
  }
}
```

### åè°ƒå™¨ Prompt

```markdown
<!-- prompts/audit-coordinator.md -->
# ä»£ç å®¡è®¡åè°ƒå™¨

## èŒè´£
åè°ƒå¤šä¸ªä¸“ä¸šå®¡è®¡ Agentï¼Œå¯¹ä»£ç å˜æ›´è¿›è¡Œå…¨æ–¹ä½å®¡è®¡ã€‚

## å®¡è®¡æµç¨‹

### 1. å˜æ›´åˆ†æ
é¦–å…ˆåˆ†ææœ¬æ¬¡å˜æ›´ï¼š
- æ¶‰åŠå“ªäº›æ–‡ä»¶
- å˜æ›´ç±»å‹ï¼ˆæ–°åŠŸèƒ½/Bugä¿®å¤/é‡æ„ï¼‰
- å˜æ›´è§„æ¨¡

### 2. å®¡è®¡ä»»åŠ¡åˆ†é…
**å¹¶è¡Œ**è°ƒç”¨ä»¥ä¸‹å®¡è®¡ä¸“å®¶ï¼š

| ä¸“å®¶ | å…³æ³¨ç‚¹ |
|------|--------|
| @security-auditor | SQLæ³¨å…¥ã€XSSã€è®¤è¯ç»•è¿‡ã€æ•æ„Ÿæ•°æ® |
| @performance-auditor | O(nÂ²)å¤æ‚åº¦ã€å†…å­˜æ³„æ¼ã€N+1æŸ¥è¯¢ |
| @quality-auditor | å‘½åã€å‡½æ•°é•¿åº¦ã€é‡å¤ä»£ç ã€SOLID |
| @test-auditor | æµ‹è¯•è¦†ç›–ã€è¾¹ç•Œæƒ…å†µã€Mockè´¨é‡ |

### 3. ç»“æœæ±‡æ€»
æ”¶é›†æ‰€æœ‰å®¡è®¡ç»“æœï¼š

**ä¸¥é‡ç¨‹åº¦å®šä¹‰**ï¼š
| ç­‰çº§ | å®šä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| Critical | å¯è¢«è¿œç¨‹åˆ©ç”¨ã€æ•°æ®æ³„éœ²é£é™© | SQLæ³¨å…¥ã€ç¡¬ç¼–ç å¯†é’¥ |
| High | éœ€ç™»å½•æ‰èƒ½åˆ©ç”¨ã€åŠŸèƒ½ç¼ºé™· | è®¤è¯ç»•è¿‡ã€èµ„æºæ³„æ¼ |
| Medium | éœ€ç‰¹å®šæ¡ä»¶è§¦å‘ | è¾¹ç•Œæ¡ä»¶æœªå¤„ç† |
| Low | ä»£ç é£æ ¼ã€è½»å¾®æ€§èƒ½ | å‘½åä¸è§„èŒƒ |

**å†²çªå¤„ç†**ï¼š
- åŒä¸€è¡Œä»£ç è¢«å¤šä¸ªå®¡è®¡å‘ç° â†’ ä¿ç•™æœ€é«˜ä¸¥é‡ç¨‹åº¦
- ç›¸äº’çŸ›ç›¾çš„å»ºè®® â†’ æ ‡è®°ä¸º"éœ€äººå·¥å¤æ ¸"
- è¯¯æŠ¥è¯†åˆ« â†’ å¦‚æœ 2+ å®¡è®¡è€…è®¤ä¸ºæ— é—®é¢˜åˆ™é™çº§

### 4. æŠ¥å‘Šç”Ÿæˆ
è°ƒç”¨ @report-generator ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šï¼š
- æ‰§è¡Œæ‘˜è¦
- è¯¦ç»†å‘ç°
- ä¿®å¤å»ºè®®
- é£é™©è¯„ä¼°

## å¤±è´¥å¤„ç†
- æŸå®¡è®¡ Agent è¶…æ—¶ï¼šè®°å½•å¹¶ç»§ç»­ï¼Œåœ¨æŠ¥å‘Šä¸­æ ‡æ³¨"éƒ¨åˆ†å®¡è®¡æœªå®Œæˆ"
- æŸå®¡è®¡ Agent æŠ¥é”™ï¼šé‡è¯•ä¸€æ¬¡ï¼Œä»å¤±è´¥åˆ™è·³è¿‡å¹¶è®°å½•
- æ— å˜æ›´å¯å®¡è®¡ï¼šç›´æ¥è¿”å›"æ— éœ€å®¡è®¡"

## è¾“å‡º
æœ€ç»ˆè¾“å‡ºç»“æ„åŒ–å®¡è®¡æŠ¥å‘Šã€‚
```

---

## è®¾è®¡æ£€æŸ¥æ¸…å•

åœ¨è®¾è®¡ Agent å‰ï¼Œé—®è‡ªå·±ï¼š

- [ ] **ç®€å•æ€§**ï¼šèƒ½ç”¨æ›´ç®€å•çš„æ–¹æ¡ˆå—ï¼Ÿ
- [ ] **æ¨¡å¼é€‰æ‹©**ï¼šé€‰å¯¹ Workflow æ¨¡å¼äº†å—ï¼Ÿ
- [ ] **å·¥å…·æè¿°**ï¼šæè¿°æ¸…æ™°ã€æ˜“äºç†è§£å—ï¼Ÿ
- [ ] **è¯„ä¼°æ ‡å‡†**ï¼šå¦‚ä½•åˆ¤æ–­ Agent å®Œæˆäº†ä»»åŠ¡ï¼Ÿ
- [ ] **å¤±è´¥å¤„ç†**ï¼šå‡ºé”™æ—¶å¦‚ä½•æ¢å¤ï¼Ÿ
- [ ] **æƒé™æ§åˆ¶**ï¼šæ˜¯å¦é™åˆ¶äº†ä¸å¿…è¦çš„æƒé™ï¼Ÿ
- [ ] **èµ„æºé™åˆ¶**ï¼šè®¾ç½®äº† steps é™åˆ¶å—ï¼Ÿ

---

## å¸¸è§è®¾è®¡é™·é˜±

| é™·é˜± | è¡¨ç° | è§£å†³ |
|------|------|------|
| **è¿‡åº¦è®¾è®¡** | ç”¨å¤š Agent è§£å†³ç®€å•é—®é¢˜ | å…ˆç”¨å• Agent å°è¯• |
| **æ¨¡ç³Šæè¿°** | description å¤ªæ³›å¯¼è‡´é”™è¯¯è°ƒç”¨ | å…·ä½“è¯´æ˜é€‚ç”¨åœºæ™¯ |
| **æ— é™å¾ªç¯** | Agent äº’ç›¸è°ƒç”¨ä¸åœæ­¢ | è®¾ç½® steps é™åˆ¶ |
| **æƒé™è¿‡æ¾** | subagent å¯ä»¥åšä»»ä½•äº‹ | æ˜ç¡® task/edit/bash æƒé™ |
| **ç¼ºä¹é€æ˜** | ä¸çŸ¥é“ Agent åœ¨åšä»€ä¹ˆ | è¦æ±‚è¾“å‡ºä¸­é—´æ­¥éª¤ |

---

## æœ¬è¯¾å°ç»“

ä½ å­¦ä¼šäº†ï¼š

1. **ä¸‰æ¡æ ¸å¿ƒåŸåˆ™**ï¼šç®€å•ã€é€æ˜ã€ç²¾å¿ƒè®¾è®¡ ACI
2. **äº”ç§ Workflow æ¨¡å¼**ï¼šæç¤ºé“¾ã€è·¯ç”±ã€å¹¶è¡ŒåŒ–ã€ç¼–æ’-å·¥äººã€è¯„ä¼°-ä¼˜åŒ–
3. **Agent ä¸‰å¤§ç»„ä»¶**ï¼šè§„åˆ’ã€è®°å¿†ã€å·¥å…·ä½¿ç”¨
4. **ä¸¤ä¸ªå®æˆ˜æ¡ˆä¾‹**ï¼šå¤šè¯­è¨€æ–‡æ¡£ç³»ç»Ÿã€ä»£ç å®¡è®¡æµæ°´çº¿
5. **è®¾è®¡æ£€æŸ¥æ¸…å•**ï¼šé¿å…å¸¸è§é™·é˜±

---

## å»¶ä¼¸é˜…è¯»

- [Anthropic: Building Effective Agents](https://www.anthropic.com/engineering/building-effective-agents)ï¼ˆ2024.12ï¼‰
- [Lilian Weng: LLM Powered Autonomous Agents](https://lilianweng.github.io/posts/2023-06-23-agent/)ï¼ˆ2023.06ï¼‰
- [OpenAI: Agents Overview](https://platform.openai.com/docs/guides/agents)

---

## ä¸‹ä¸€è¯¾é¢„å‘Š

> è®¾è®¡å¥½ Agent åï¼Œå¦‚ä½•ç²¾ç¡®æ§åˆ¶å®ƒèƒ½åšä»€ä¹ˆã€ä¸èƒ½åšä»€ä¹ˆï¼Ÿä¸‹ä¸€è¯¾æ·±å…¥æƒé™ç³»ç»Ÿã€‚

**ä¸‹ä¸€è¯¾**ï¼š[5.2c Agent æƒé™ä¸å®‰å…¨](./02c-agent-permissions)
